<!DOCTYPE html>
<html>
<body>
  <script src="../js/jquery-1.11.0.min.js"></script>
  <script src="../js/croquis.js"></script>
  <div id="canvas-area"></div>
  <p>크기</p>
  <input id="size-slider" type="range" min="0" max="50">
  <br>
  <p>흐름</p>
  <input id="flow-slider" type="range" min="0" max="1" step="0.001">
  <br>
  <p>간격</p>
  <input id="spacing-slider" type="range" min="0" max="5" step="0.001">
  <br>
  <p>각도</p>
  <input id="angle-slider" type="range" min="0" max="360">
  <br>
  <span>방향에 맞춰 회전</span>
  <input id="rotate-to-direction-checkbox" type="checkbox">
  <br>
  <p>흩뿌림</p>
  <input id="normal-spread-slider" type="range" min="0" max="10" step="0.001">
  <br>
  <p>평행 흩뿌림</p>
  <input id="tangent-spread-slider" type="range" min="0" max="10" step="0.001">
  <script>
  window.title = "브러시 설정";
  window.terminate = function (global) {
    global.viewport.updateBrushPointer();
  };
  window.initialize = function (global) {
    var w = 400;
    var h = 100;
    var brush = global.tool.brush;
    var previewCroquis = new Croquis();
    var previewBrush = new Croquis.Brush();
    $('#canvas-area').append(previewCroquis.getDOMElement());
    with (previewCroquis) {
      lockHistory();
      setCanvasSize(w, h);
      addLayer();
      fillLayer('#fff');
      addLayer();
      selectLayer(1);
      setToolStabilizeLevel(0);
      setTool(previewBrush);
    }
    with (previewBrush) {
      setColor('#000');
      setSize(brush.getSize());
      setFlow(brush.getFlow());
      setSpacing(brush.getSpacing());
      setAngle(brush.getAngle());
      setNormalSpread(brush.getNormalSpread());
      setTangentSpread(brush.getTangentSpread());
      setRotateToDirection(brush.getRotateToDirection());
    }
    var sizeSlider = $('#size-slider').get(0);
    var flowSlider = $('#flow-slider').get(0);
    var spacingSlider = $('#spacing-slider').get(0);
    var angleSlider = $('#angle-slider').get(0);
    var normalSpreadSlider = $('#normal-spread-slider').get(0);
    var tangentSpreadSlider = $('#tangent-spread-slider').get(0);
    var rotateToDirectionCheckbox = $('#rotate-to-direction-checkbox').get(0);
    sizeSlider.value = brush.getSize();
    flowSlider.value = brush.getFlow();
    spacingSlider.value = brush.getSpacing();
    angleSlider.value = brush.getAngle();
    normalSpreadSlider.value = brush.getNormalSpread();
    tangentSpreadSlider.value = brush.getTangentSpread();
    rotateToDirectionCheckbox.checked = brush.getRotateToDirection();
    sizeSlider.onchange = function () {
      brush.setSize(sizeSlider.value);
      previewBrush.setSize(sizeSlider.value);
      updatePreview();
    };
    flowSlider.onchange = function () {
      brush.setFlow(flowSlider.value);
      previewBrush.setFlow(flowSlider.value);
      updatePreview();
    };
    spacingSlider.onchange = function () {
      brush.setSpacing(spacingSlider.value);
      previewBrush.setSpacing(spacingSlider.value);
      updatePreview();
    };
    angleSlider.onchange = function () {
      brush.setAngle(angleSlider.value);
      previewBrush.setAngle(angleSlider.value);
      updatePreview();
    };
    normalSpreadSlider.onchange = function () {
      brush.setNormalSpread(normalSpreadSlider.value);
      previewBrush.setNormalSpread(normalSpreadSlider.value);
      updatePreview();
    };
    tangentSpreadSlider.onchange = function () {
      brush.setTangentSpread(tangentSpreadSlider.value);
      previewBrush.setTangentSpread(tangentSpreadSlider.value);
      updatePreview();
    };
    rotateToDirectionCheckbox.onchange = function () {
      brush.setRotateToDirection(rotateToDirectionCheckbox.checked);
      previewBrush.setRotateToDirection(rotateToDirectionCheckbox.checked);
      updatePreview();
    };
    function updatePreview() {
      var deg360 = Math.PI * 2;
      var deg180 = Math.PI;
      var halfH = h >> 1;
      var padding = 30;
      var paddedWidth = w - padding * 2;
      var amplitude = halfH - padding;
      previewBrush.setRandomFunction((new Croquis.Random.LFSR113).get);
      previewCroquis.clearLayer();
      previewCroquis.down(padding, halfH, 0);
      for (var t = 0; t < 1; t += 0.01) {
        var horizontalPos = t * paddedWidth + padding;
        var verticalPos = -Math.sin(deg360 * t) * amplitude + halfH;
        previewCroquis.move(horizontalPos, verticalPos, 1 - Math.abs(t * 2 - 1));
      }
      previewCroquis.up(w - padding, halfH, 0);
    }
    updatePreview();
  };
  </script>
</body>
</html>
